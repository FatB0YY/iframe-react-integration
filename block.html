<style>
  .iframe-wrapper {
    width: 100%;
    height: 100%;
    border-radius: 20px;
    background: #fff;
    position: relative;
  }

  .iframe-wrapper iframe {
    border-radius: 20px;
    clip-path: inset(0 round 20px);
  }

  @supports selector(.t-popup:has(.ps-popup-config)) {
    .t-popup:has(.ps-popup-config) .t-popup__container,
    .t-popup:has(.ps-popup-config) .t-popup__content {
      border-radius: 20px !important;
    }

    .t-popup:has(.ps-popup-config) .t-popup__container {
      height: 95%;
      max-width: 660px;
      left: 0 !important;
      right: 0 !important;
    }

    .t-popup:has(.ps-popup-config) .t-popup__close,
    .t-popup:has(.ps-popup-config) [data-tilda-popup-close] {
      display: none !important;
    }

    .t-popup:has(.ps-popup-config) .t868__code-wrap {
      height: 100%;
    }

    .t-popup:has(.ps-popup-config) .ps-popup-config,
    .t-popup:has(.ps-popup-config) .ps-iframe-slot,
    .t-popup:has(.ps-popup-config) .iframe-wrapper {
      height: 100%;
    }
  }

  .ps-loader {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fff;
    z-index: 2;
    border-radius: 20px !important;
  }

  .ps-loader::after {
    content: '';
    width: 40px;
    height: 40px;
    border: 4px solid #eee;
    border-top-color: #0e62f0;
    border-radius: 50%;
    animation: ps-spin 0.8s linear infinite;
  }

  @keyframes ps-spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>

<div class="iframe-wrapper" id="ps-iframe-wrapper" style="display: none">
  <div class="ps-loader" id="ps-loader"></div>

  <iframe
    id="product-sense-next-iframe"
    src="about:blank"
    style="width: 100%; height: 100%; border: 0"
    title="Next iframe"
  ></iframe>
</div>

<script>
  (function () {
    function debounce(fn, wait) {
      var timeoutId = null;

      return function () {
        var context = this;
        var args = arguments;

        if (timeoutId) {
          clearTimeout(timeoutId);
        }

        timeoutId = setTimeout(function () {
          timeoutId = null;
          fn.apply(context, args);
        }, wait);
      };
    }

    var debouncedHandlePopupStateChange = debounce(function () {
      handlePopupStateChange();
    }, 50);

    var pendingAnimationFrame = null;

    var NEXT_APPLICATION_ORIGIN = '';
    var ORDER_CREATE_BASE_URL = NEXT_APPLICATION_ORIGIN + '/order-create';
    var IFRAME_ELEMENT_ID = 'product-sense-next-iframe';

    var SOURCE_PARENT_APPLICATION = 'product-sense-tilda-parent';
    var SOURCE_NEXT_APPLICATION = 'product-sense-next-client';

    var IFRAME_WRAPPER_ELEMENT_ID = 'ps-iframe-wrapper';
    var LAST_OPENED_POPUP_ELEMENT = null;

    function postMessageToIframe(messageType, payload) {
      var iframeElement = document.getElementById(IFRAME_ELEMENT_ID);

      if (!iframeElement || !iframeElement.contentWindow) {
        return;
      }

      iframeElement.contentWindow.postMessage(
        {
          source: SOURCE_PARENT_APPLICATION,
          type: messageType,
          payload: payload,
        },
        NEXT_APPLICATION_ORIGIN,
      );
    }

    function isPopupOpened(popupElement) {
      if (!popupElement) {
        return false;
      }

      return (
        popupElement.classList.contains('t-popup_show') ||
        popupElement.classList.contains('t-popup-show') ||
        popupElement.style.display === 'block'
      );
    }

    function findActivePopupConfiguration() {
      var popupElements = document.querySelectorAll('.t-popup');

      for (var index = 0; index < popupElements.length; index++) {
        var popupElement = popupElements[index];

        if (!isPopupOpened(popupElement)) {
          continue;
        }

        var popupConfigurationElement = popupElement.querySelector('.ps-popup-config');

        if (popupConfigurationElement) {
          return {
            popupElement: popupElement,
            popupConfigurationElement: popupConfigurationElement,
          };
        }
      }

      return null;
    }

    function buildIframeUrl(eventId, tariffId) {
      var urlObject = new URL(ORDER_CREATE_BASE_URL);

      if (eventId) {
        urlObject.searchParams.set('eventId', eventId);
      }

      if (tariffId) {
        urlObject.searchParams.set('tariffId', tariffId);
      }

      return urlObject.toString();
    }

    function mountIframeInto(containerElement) {
      var iframeWrapperElement = document.getElementById(IFRAME_WRAPPER_ELEMENT_ID);

      if (!iframeWrapperElement) {
        return null;
      }

      if (containerElement && iframeWrapperElement.parentNode !== containerElement) {
        containerElement.appendChild(iframeWrapperElement);
      }

      iframeWrapperElement.style.display = 'block';

      return document.getElementById(IFRAME_ELEMENT_ID);
    }

    function handlePopupStateChange() {
      var activePopupData = findActivePopupConfiguration();

      if (!activePopupData) {
        if (LAST_OPENED_POPUP_ELEMENT) {
          postMessageToIframe('POPUP_CLOSED', { timestamp: Date.now() });
          LAST_OPENED_POPUP_ELEMENT = null;

          hideLoader();

          var iframeWrapperElement = document.getElementById(IFRAME_WRAPPER_ELEMENT_ID);
          if (iframeWrapperElement) {
            iframeWrapperElement.style.display = 'none';
          }
        }
        return;
      }

      if (LAST_OPENED_POPUP_ELEMENT !== activePopupData.popupElement) {
        LAST_OPENED_POPUP_ELEMENT = activePopupData.popupElement;

        var eventId = activePopupData.popupConfigurationElement.getAttribute('data-event-id') || '';
        var tariffId = activePopupData.popupConfigurationElement.getAttribute('data-tariff-id') || '';

        var iframeContainerElement =
          activePopupData.popupConfigurationElement.querySelector('.ps-iframe-slot') ||
          activePopupData.popupConfigurationElement;

        var iframeElement = mountIframeInto(iframeContainerElement);

        if (!iframeElement) {
          return;
        }

        showLoader();

        iframeElement.addEventListener('load', hideLoader, { once: true });

        iframeElement.src = buildIframeUrl(eventId, tariffId);
      }
    }

    var mutationObserver = new MutationObserver(function () {
      if (pendingAnimationFrame) return;

      pendingAnimationFrame = requestAnimationFrame(function () {
        pendingAnimationFrame = null;
        debouncedHandlePopupStateChange();
      });
    });

    mutationObserver.observe(document.body, {
      attributes: true,
      childList: true,
      subtree: true,
    });

    handlePopupStateChange();

    function blockEvent(event) {
      event.preventDefault();
      event.stopPropagation();
      event.stopImmediatePropagation();
    }

    function getActivePopupElement() {
      return LAST_OPENED_POPUP_ELEMENT;
    }

    function showLoader() {
      var loader = document.getElementById('ps-loader');
      if (loader) loader.style.display = 'flex';
    }

    function hideLoader() {
      var loader = document.getElementById('ps-loader');
      if (loader) loader.style.display = 'none';
    }

    document.addEventListener(
      'click',
      function (event) {
        var closeButtonElement =
          event.target.closest && event.target.closest('.t-popup__close, [data-tilda-popup-close]');

        if (!closeButtonElement) {
          return;
        }

        var popupElement = getActivePopupElement();

        if (!isPopupOpened(popupElement)) {
          return;
        }

        if (!popupElement.contains(closeButtonElement)) {
          return;
        }

        blockEvent(event);
        postMessageToIframe('REQUEST_CLOSE', { via: 'close_button' });
      },
      true,
    );

    document.addEventListener(
      'click',
      function (event) {
        var popupElement = getActivePopupElement();

        if (!isPopupOpened(popupElement)) {
          return;
        }

        if (event.target === popupElement) {
          blockEvent(event);
          postMessageToIframe('REQUEST_CLOSE', { via: 'overlay_click' });
        }
      },
      true,
    );

    document.addEventListener(
      'keydown',
      function (event) {
        var isEscapeKeyPressed = event.key === 'Escape';

        if (!isEscapeKeyPressed) {
          return;
        }

        var popupElement = getActivePopupElement();

        if (!isPopupOpened(popupElement)) {
          return;
        }

        blockEvent(event);
        postMessageToIframe('REQUEST_CLOSE', { via: 'esc' });
      },
      true,
    );

    window.addEventListener('message', function (event) {
      if (event.origin !== NEXT_APPLICATION_ORIGIN) {
        return;
      }

      var messageData = event.data || {};

      if (messageData.source !== SOURCE_NEXT_APPLICATION) {
        return;
      }

      if (messageData.type === 'RELOAD_PARENT') {
        window.location.reload();
        return;
      }
    });
  })();
</script>
